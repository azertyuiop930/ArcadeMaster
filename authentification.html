<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ArcadeMaster - Compte</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Styles de la page */
        .auth-container { max-width: 450px; margin: 80px auto; padding: 30px; background-color: var(--color-surface); border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); text-align: center; }
        .auth-container h1 { color: var(--color-primary); margin-bottom: 25px; font-size: 2em; }
        .auth-form { display: flex; flex-direction: column; gap: 15px; padding-top: 15px; }

        /* Styles pour les cases */
        .auth-form input[type="text"], .auth-form input[type="password"], .auth-form input[type="url"] { padding: 15px; border: 2px solid #555; border-radius: 8px; background-color: #1c1c1c; color: #00ff00; font-size: 1.1em; transition: border-color 0.2s, box-shadow 0.2s; }
        .auth-form input:focus { border-color: #00ff00; box-shadow: 0 0 10px rgba(0, 255, 0, 0.5); outline: none; }
        
        /* Styles pour les boutons */
        .auth-form button, .logout-button { padding: 15px; background-color: #00ff00; color: black; border: none; border-radius: 8px; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .auth-form button:hover { background-color: #00cc00; transform: translateY(-2px); }

        .message { margin-top: 15px; padding: 10px; border-radius: 5px; font-weight: bold; color: white; display: none; }
        .message.error { background-color: #e74c3c; }
        .message.success { background-color: #27ae60; }
        .switch-mode { margin-top: 20px; color: var(--color-text); cursor: pointer; font-size: 0.9em; text-decoration: underline; }
        .pdp-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 10px auto 20px auto; border: 3px solid var(--color-primary); display: block; }

        /* Styles du panneau de compte */
        .account-panel { text-align: left; color: var(--color-text); }
        .account-panel h1 { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
        .account-info p { font-size: 1.1em; margin-bottom: 15px; }
        .account-info strong { color: #f39c12; display: inline-block; width: 150px; }
        .account-panel .logout-button { background-color: #e74c3c; margin-top: 20px; width: 100%; }
        .account-panel .logout-button:hover { background-color: #c0392b; }
    </style>
    <script>
        function toggleMenu(x) {
            x.classList.toggle("change");
            const sidebar = document.getElementById("sidebar");
            if (sidebar.style.width === "250px") {
                sidebar.style.width = "0";
            } else {
                sidebar.style.width = "250px";
            }
        }
        
        function switchAuthMode(mode) {
            const container = document.getElementById('auth-container');
            const formHTML = document.getElementById('form-content');
            const isLogin = mode === 'login';
            
            // On s'assure que h1 et formHTML existent avant de continuer
            if (!container || !formHTML) return;

            if (isLogin) {
                container.querySelector('h1').textContent = 'Se Connecter';
                formHTML.innerHTML = `
                    <form id="login-form" onsubmit="handleLogin(event)" class="auth-form">
                        <input type="text" id="login-username" placeholder="Nom d'utilisateur" required autocomplete="username">
                        <input type="password" id="login-password" placeholder="Mot de passe" required autocomplete="current-password">
                        <button type="submit">Connexion</button>
                    </form>
                `;
                document.getElementById('switch-mode-button').textContent = "Pas de compte ? S'inscrire ici.";
                document.getElementById('switch-mode-button').onclick = () => switchAuthMode('register');
            } else {
                container.querySelector('h1').textContent = 'Cr√©er un Compte';
                formHTML.innerHTML = `
                    <form id="register-form" onsubmit="handleRegister(event)" class="auth-form">
                        <input type="text" id="register-username" placeholder="Nom d'utilisateur" required autocomplete="username">
                        <input type="password" id="register-password" placeholder="Mot de passe (min 5 caract√®res)" required minlength="5" autocomplete="new-password">
                        <input type="url" id="register-pdp" placeholder="URL Image de Profil (Optionnel)" oninput="previewPdp(this.value)">
                        <img id="pdp-preview" class="pdp-preview" src="https://i.imgur.com/39hN7hG.png" alt="Aper√ßu PDP" style="display:none;">
                        <button type="submit">Inscription</button>
                    </form>
                `;
                document.getElementById('switch-mode-button').textContent = "D√©j√† un compte ? Se connecter ici.";
                document.getElementById('switch-mode-button').onclick = () => switchAuthMode('login');
            }
            hideMessage();
        }
        
        function previewPdp(url) {
            const img = document.getElementById('pdp-preview');
            if (url) {
                img.src = url;
                img.style.display = 'block';
            } else {
                img.style.display = 'none';
                img.src = 'https://i.imgur.com/39hN7hG.png'; 
            }
        }

        function showMessage(type, text) {
            const msg = document.getElementById('message');
            msg.className = `message ${type}`;
            msg.textContent = text;
            msg.style.display = 'block';
        }
        function hideMessage() {
            document.getElementById('message').style.display = 'none';
        }

        function handleLogin(event) {
            event.preventDefault();
            hideMessage();
            if (typeof login !== 'function') { showMessage('error', "Erreur: Le script d'authentification (auth.js) n'est pas charg√©."); return; }
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (login(username, password)) {
                showMessage('success', `Connexion r√©ussie ! Redirection en cours...`);
                setTimeout(() => {
                    window.location.href = 'index.html'; 
                }, 1000);
            } else {
                showMessage('error', 'Nom d\'utilisateur ou mot de passe incorrect.');
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            hideMessage();
            if (typeof registerUser !== 'function') { showMessage('error', "Erreur: Le script d'authentification (auth.js) n'est pas charg√©."); return; }
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const pdp = document.getElementById('register-pdp').value;

            if (username.length < 3) { showMessage('error', 'Le nom d\'utilisateur doit contenir au moins 3 caract√®res.'); return; }

            if (registerUser(username, password, pdp)) {
                showMessage('success', `Inscription r√©ussie ! Veuillez vous connecter.`);
                setTimeout(() => {
                    switchAuthMode('login');
                }, 1500);
            } else {
                showMessage('error', `Le nom d\'utilisateur "${username}" est d√©j√† pris.`);
            }
        }
    </script>
</head>
<body>
    
    <div id="navbar">
        <div class="hamburger-menu" onclick="toggleMenu(this)">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
        <div id="auth-controls">
            </div>
    </div>

    <div id="sidebar">
        <a href="index.html">üè† Accueil</a>
        <a href="jeux.html">üïπÔ∏è Menu Jeux</a>
        <a href="credits.html">üìù Cr√©dits</a>
        <a href="authentification.html">‚öôÔ∏è Compte</a>
    </div>

    <div class="container">
        <div class="auth-container" id="auth-container">
            <h1>Authentification</h1> 
            
            <div id="form-content"></div> 
            
            <div id="message" class="message"></div>
            
            <div id="switch-mode-button" class="switch-mode"></div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        // Initialisation de la page
        window.onload = () => { 
             if (typeof renderAuthControls === 'function') {
                 renderAuthControls(); // Met √† jour la navbar
             }
             
             const currentUser = getCurrentUser();
             const authContainer = document.getElementById('auth-container');

             if (currentUser) {
                 const userData = getUserData(currentUser);
                 const pdpUrl = userData && userData.pdp ? userData.pdp : 'https://i.imgur.com/39hN7hG.png';
                 
                 // AFFICHAGE DU PANNEAU COMPTE
                 authContainer.innerHTML = `
                    <div class="account-panel">
                        <h1 style="text-align: center;">Mon Compte Utilisateur</h1>
                        <img src="${pdpUrl}" alt="Photo de profil" class="pdp-preview">
                        <div class="account-info">
                            <p><strong>Nom d'utilisateur :</strong> ${currentUser}</p>
                            <p><strong>R√¥le :</strong> <span>${userData.role === 'admin' ? 'üëë ADMINISTRATEUR' : 'Joueur Standard'}</span></p>
                            <p><strong>Statut :</strong> <span style="color: #00ff00;">Connect√©</span></p>
                            <p><strong>Meilleur score Invaders :</strong> <span>${userData.games.space_invaders ? userData.games.space_invaders.highScore : '0'}</span></p>
                        </div>
                        <button class="logout-button" onclick="logout()">D√©connexion</button>
                    </div>
                 `;
             } else {
                 // S'il n'est pas connect√©, le conteneur doit exister pour que switchAuthMode le remplisse
                 if (authContainer) {
                    // Pour garantir que les √©l√©ments existent pour switchAuthMode, on fait le rendu du formulaire par d√©faut.
                    switchAuthMode('login'); 
                 }
             }
        };
    </script>
</body>
</html>
