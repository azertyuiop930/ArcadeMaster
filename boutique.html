<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcade Master - Boutique</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Styles sp√©cifiques de la boutique (inclus ici pour la portabilit√©) */
        .shop-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            gap: 20px;
            margin-top: 20px;
        }
        .shop-card {
            flex: 0 1 250px; 
            padding: 20px;
            background-color: var(--color-background-dark);
            border-radius: 10px;
            border: 2px solid var(--color-neon-blue);
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.2);
            text-align: center;
        }
        .shop-card .item-icon {
            font-size: 3em;
            display: block;
            margin-bottom: 10px;
        }
        .shop-card .price {
            font-weight: bold;
            font-size: 1.2em;
            margin: 10px 0;
            color: var(--color-neon-green);
        }
    </style>
</head>
<body>
    
    <div id="top-bar"></div>
    <div id="sidebar" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <div id="nav-links"></div>
    </div>

    <div class="main-container" id="mainContent">
        
        <h1 style="color: var(--color-neon-orange); text-align: center;">BOUTIQUE ARCADE</h1>
        <hr>
        
        <div class="centered-container" id="notConnectedMessage" style="display: none;">
            <p style="color: var(--color-text-medium); margin-bottom: 30px; font-size: 1.1em;">
                Vous devez √™tre <strong style="color: var(--color-neon-green);">connect√©</strong> pour acc√©der √† la boutique et acheter/√©quiper des skins.
            </p>
            <a href="compte.html" class="btn-primary" style="background-color: var(--color-neon-green);">
                <i class="fas fa-sign-in-alt"></i> Se connecter maintenant
            </a>
        </div>
        
        <div id="boutiqueContent" style="display: none;">
            
            <section class="items-section">
                <h2 style="color: var(--color-neon-blue); margin-bottom: 20px;">SKINS DE VAISSEAU</h2>
                
                <div class="shop-list">
                    
                    <div class="shop-card" data-item-id="vessel_base">
                        <span class="item-icon" style="color: var(--color-neon-green);">üöÄ</span>
                        <h3 style="color: var(--color-neon-green);">Vaisseau Standard</h3>
                        <p class="price" style="color: var(--color-text-light);">Gratuit</p>
                        <button class="btn-primary btn-equip" style="background-color: var(--color-neon-blue);" disabled>
                            √âquip√©
                        </button>
                    </div>

                    <div class="shop-card" data-item-id="vessel_ninja">
                        <span class="item-icon" style="color: var(--color-text-medium);">üåë</span>
                        <h3 style="color: var(--color-text-light);">Skin Ninja</h3>
                        <p class="price">15 000 üí∞</p>
                        <button class="btn-primary btn-buy" style="background-color: var(--color-neon-green);">
                            Acheter
                        </button>
                    </div>

                    <div class="shop-card" data-item-id="vessel_gold">
                        <span class="item-icon" style="color: gold;">üèÜ</span>
                        <h3 style="color: var(--color-neon-orange);">Vaisseau Gold</h3>
                        <p class="price">500 üí∞</p>
                        <button class="btn-primary btn-buy" style="background-color: var(--color-neon-green);">
                            Acheter
                        </button>
                    </div>

                </div>
            </section>
            
            <hr style="margin: 40px 0;">

            <section class="items-section">
                <h2 style="color: var(--color-neon-blue); margin-bottom: 20px;">SKINS DE MONSTRE</h2>
                
                <div class="shop-list">
                    
                    <div class="shop-card" data-item-id="monster_squid">
                        <span class="item-icon" style="color: purple;">ü¶ë</span>
                        <h3 style="color: var(--color-neon-purple);">Squid Alien</h3>
                        <p class="price">25 000 üí∞</p>
                        <button class="btn-primary btn-buy" style="background-color: var(--color-neon-green);">
                            Acheter
                        </button>
                    </div>
                    
                    <div class="shop-card" data-item-id="monster_ghost">
                        <span class="item-icon" style="color: white;">üëª</span>
                        <h3 style="color: var(--color-neon-red);">Fant√¥me</h3>
                        <p class="price">50 000 üí∞</p>
                        <button class="btn-primary btn-buy" style="background-color: var(--color-neon-green);">
                            Acheter
                        </button>
                    </div>
                </div>
            </section>

            <hr style="margin: 40px 0;">

            <section class="items-section centered-container" style="max-width: 800px; text-align: center;">
                <h2 style="color: var(--color-neon-red); margin-bottom: 20px;">ACHAT DE PI√àCES (Argent R√©el)</h2>
                <p style="color: var(--color-text-medium); margin-bottom: 30px;">Soutenez le d√©veloppement et obtenez instantan√©ment des pi√®ces pour la boutique !</p>
                
                <div class="shop-list" style="justify-content: center;">
                    
                    <div class="shop-card" style="border-color: var(--color-neon-red); box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);">
                        <span class="item-icon" style="color: var(--color-neon-orange);">üíé</span>
                        <h3 style="color: var(--color-neon-orange);">1 000 Pi√®ces</h3>
                        <p class="price" style="color: var(--color-neon-red);">4.99 ‚Ç¨</p>
                        <a href="rickroll.html" class="btn-primary" style="background-color: var(--color-neon-red);">
                            Acheter
                        </a>
                    </div>
                    
                    <div class="shop-card" style="border-color: var(--color-neon-red); box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);">
                        <span class="item-icon" style="color: var(--color-neon-orange);">üëë</span>
                        <h3 style="color: var(--color-neon-orange);">2 500 Pi√®ces</h3>
                        <p class="price" style="color: var(--color-neon-red);">10.00 ‚Ç¨</p>
                        <a href="rickroll.html" class="btn-primary" style="background-color: var(--color-neon-red);">
                            Acheter
                        </a>
                    </div>
                </div>
            </section>

        </div>
    </div>
    
    <script src="base.js"></script>
    <script src="auth.js"></script>
    <script>
        // Fonction utilitaire pour obtenir les donn√©es de l'article de la carte
        function getItemData(card) {
            const priceText = card.querySelector('.price').textContent;
            // Tente de trouver un nombre (avec ou sans espace) avant le üí∞
            const priceMatch = priceText.match(/(\d[\d\s]*)/); 
            const price = priceMatch ? parseInt(priceMatch[0].replace(/\s/g, '')) : 0;
            const itemId = card.dataset.itemId;
            const itemType = itemId.split('_')[0]; // 'vessel' ou 'monster'
            
            return { price, itemId, itemType };
        }
        
        // Fonction pour mettre √† jour l'√©tat visuel d'une carte
        function updateCardVisual(card, user) {
            const item = getItemData(card);
            const isOwned = user.skins.owned && user.skins.owned[item.itemId];
            const isActive = user.skins.active && user.skins.active[item.itemType] === item.itemId;
            
            card.dataset.owned = isOwned ? 'true' : 'false';
            card.dataset.equipped = isActive ? 'true' : 'false';

            const button = card.querySelector('.btn-primary');

            if (isActive) {
                button.textContent = '√âquip√©';
                button.disabled = true;
                button.style.backgroundColor = 'var(--color-neon-blue)';
                card.querySelector('.price').textContent = 'Poss√©d√©';
                card.querySelector('.price').style.color = 'var(--color-text-light)';
            } else if (isOwned) {
                button.textContent = '√âquiper';
                button.disabled = false;
                button.style.backgroundColor = 'var(--color-neon-orange)';
                button.classList.remove('btn-buy');
                button.classList.add('btn-equip');
                card.querySelector('.price').textContent = 'Poss√©d√©';
                card.querySelector('.price').style.color = 'var(--color-text-light)';
            } else {
                 // Non poss√©d√©
                button.textContent = 'Acheter';
                button.disabled = false;
                button.style.backgroundColor = 'var(--color-neon-green)';
                button.classList.remove('btn-equip');
                button.classList.add('btn-buy');
                card.querySelector('.price').textContent = `${item.price.toLocaleString('fr-FR')} üí∞`;
                card.querySelector('.price').style.color = 'var(--color-neon-green)';
            }
        }
        
        // Logique principale
        document.addEventListener('DOMContentLoaded', () => {
            const user = typeof getCurrentUser === 'function' ? getCurrentUser() : { id: 0, skins: { active: {}, owned: {} } };
            const notConnected = document.getElementById('notConnectedMessage');
            const content = document.getElementById('boutiqueContent');
            const shopCards = document.querySelectorAll('.shop-card');

            if (user.id !== 0) {
                notConnected.style.display = 'none';
                content.style.display = 'block';

                // 1. Initialiser l'√©tat visuel des cartes selon l'utilisateur
                shopCards.forEach(card => updateCardVisual(card, user));
            } else {
                notConnected.style.display = 'block';
                content.style.display = 'none';
                return; // Arr√™ter si d√©connect√©
            }
            
            // 2. √âcouteurs d'√©v√©nements pour Achat et √âquipement
            
            shopCards.forEach(card => {
                const item = getItemData(card);

                card.addEventListener('click', (e) => {
                    const button = e.target.closest('.btn-primary');
                    if (!button) return;

                    if (button.classList.contains('btn-buy')) {
                        
                        if (window.deductCoins(item.price)) {
                            window.addOwnedSkin(item.itemId);
                            alert(`Achat r√©ussi ! ${item.itemId} est maintenant dans votre inventaire.`);
                            
                            // Recharger l'√©tat de la carte apr√®s l'achat
                            const updatedUser = getCurrentUser();
                            updateCardVisual(card, updatedUser);

                        } else {
                            alert(`√âchec de l'achat : Fonds insuffisants (besoin de ${item.price.toLocaleString('fr-FR')} pi√®ces) !`);
                        }
                    } 
                    
                    else if (button.classList.contains('btn-equip')) {
                        
                        window.equipSkin(item.itemId, item.itemType);
                        alert(`Skin √©quip√© : ${item.itemId}.`);

                        // Recharger l'√©tat de TOUTES les cartes apr√®s l'√©quipement
                        const updatedUser = getCurrentUser();
                        shopCards.forEach(c => updateCardVisual(c, updatedUser));
                    }
                });
            });
        });
    </script>
</body>
</html>
