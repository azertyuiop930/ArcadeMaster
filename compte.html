<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcade Master - Mon Compte</title>
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Style pour l'image de profil */
        .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid var(--color-neon-orange);
            object-fit: cover;
            margin-bottom: 15px;
        }
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        /* Styles pour les liens/boutons personnalis√©s */
        .btn-link-action {
            display: block;
            width: 100%;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border-radius: 5px;
            margin-top: 15px;
            cursor: pointer;
            text-decoration: none; /* Enl√®ve le soulignement du lien */
            color: black; /* Texte en noir sur les boutons n√©ons */
            transition: background-color 0.2s;
        }
    </style>
</head>
<body>

    <div id="top-bar">
        <div id="menuToggle" class="menu-toggle">
            <i class="fa-solid fa-bars"></i>
        </div>
        <span style="font-size: 1.5em; font-weight: bold; color: var(--color-neon-green);">
            MON COMPTE
        </span>
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="boutique.html" class="currency-display" title="Boutique">
                <span class="coin-count">0</span>
                <button id="trollButton" type="button">+</button>
            </a>
            <a href="compte.html" style="color: var(--color-text-light);" title="Mon Compte" data-emoji="üë§">
                üë§
            </a>
        </div>
    </div>

    <div id="sidebar" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" id="closeNav" onclick="closeNav()" style="position: absolute; top: 0; right: 25px; font-size: 36px; color: var(--color-neon-orange);">&times;</a>
        <div id="nav-links">
            <a href="index.html" data-emoji="üè†">üè† Accueil</a>
            <a href="jeux.html" data-emoji="üéÆ">üéÆ Menu Jeux</a>
            <a href="compte.html" data-emoji="üë§">üë§ Mon Compte</a>
            <a href="boutique.html" data-emoji="üõçÔ∏è">üõçÔ∏è Boutique</a>
            <a href="classement.html" data-emoji="üèÜ">üèÜ Classement</a>
            <a href="credits.html" data-emoji="üìú">üìú Cr√©dits</a>
        </div>
    </div>

    <div class="main-container" id="mainContent">
        <div style="padding-top: 50px;"></div> 
        
        <h1 style="font-size: 2.5em; color: var(--color-neon-orange); text-align: center;">CONNEXION / INSCRIPTION</h1>

        <div id="authContainer">
            </div>

        <div id="profileView" class="auth-card" style="display: none;">
            <div class="profile-header">
                <img id="profilePicture" class="profile-pic" src="" alt="Photo de profil">
                <h2 style="color: var(--color-neon-green);">Bienvenue, <span id="profileUsername"></span> !</h2>
            </div>
            
            <div class="stats-card" style="margin-top: 0px;">
                <div class="stat-item">
                    <span>ID Utilisateur</span>
                    <span id="profileID"></span>
                </div>
                <div class="stat-item">
                    <span>Pi√®ces üí∞</span>
                    <span id="profileCoins"></span>
                </div>
                <div class="stat-item">
                    <span>Meilleur Score (Invaders) üèÜ</span>
                    <span id="profileHighScore"></span>
                </div>
                <div class="stat-item">
                    <span>R√¥le</span>
                    <span id="profileRole"></span>
                </div>
            </div>

            <h3 style="color: var(--color-neon-orange); margin-top: 30px;">Gestion du Compte</h3>
            
            <form id="profileUpdateForm">
                <label style="color: var(--color-text-light); display: block; margin-top: 15px;">Nouvelle URL de Photo de Profil (Laissez vide pour garder l'actuelle)</label>
                <input type="url" id="newProfilePicUrl" placeholder="URL de l'image">
                
                <label style="color: var(--color-text-light); display: block; margin-top: 15px;">Nouveau Mot de Passe (Laissez vide pour garder l'actuel)</label>
                <input type="password" id="newPassword" placeholder="Nouveau mot de passe">
                <input type="password" id="confirmNewPassword" placeholder="Confirmer le nouveau mot de passe">

                <button type="submit" class="btn-primary" style="background-color: var(--color-neon-blue); width: 100%; margin-top: 15px;">
                    Mettre √† Jour le Profil
                </button>
            </form>
            
            <h3 style="color: var(--color-neon-orange); margin-top: 30px;">Skins Actifs</h3>
            <div id="activeSkins" class="skin-display-group">
                <span class="skin-item">Vaisseau: <b id="activeShip">üöÄ</b></span>
            </div>

            <button onclick="logoutUser()" class="btn-primary" style="background-color: var(--color-neon-red); margin-top: 30px;">
                Se D√©connecter
            </button>
        </div>

        <div id="loginForm" class="auth-card">
            <h2>Se Connecter</h2>
            <form>
                <input type="text" id="loginUsername" placeholder="Nom d'utilisateur" required>
                <input type="password" id="loginPassword" placeholder="Mot de passe" required>
                
                <a href="javascript:void(0)" onclick="validateLogin()" class="btn-link-action" style="background-color: var(--color-neon-green);">
                    Connexion
                </a>
            </form>
            <p onclick="showRegister()" style="cursor: pointer; color: var(--color-neon-green); margin-top: 15px;">Pas de compte ? S'inscrire</p>
        </div>

        <div id="registerForm" class="auth-card" style="display: none;">
            <h2>Cr√©er un Compte</h2>
            <form>
                <input type="text" id="registerUsername" placeholder="Nom d'utilisateur" required>
                <input type="password" id="registerPassword" placeholder="Mot de passe" required>
                
                <a href="javascript:void(0)" onclick="validateRegister()" class="btn-link-action" style="background-color: var(--color-neon-orange);">
                    Inscription
                </a>
            </form>
            <p onclick="showLogin()" style="cursor: pointer; color: var(--color-neon-green); margin-top: 15px;">D√©j√† un compte ? Se Connecter</p>
        </div>
        
    </div>
    
    <script src="base.js"></script>
    <script src="auth.js"></script>
    <script>
        // Logique d'affichage des vues
        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('profileView').style.display = 'none';
        }
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('profileView').style.display = 'none';
        }

        function renderAccountPage() {
            const user = getCurrentUser();

            if (user) {
                // Remplissage des champs du profil
                document.getElementById('profileUsername').textContent = user.username;
                document.getElementById('profileID').textContent = user.id;
                document.getElementById('profileCoins').textContent = user.coins;
                document.getElementById('profileHighScore').textContent = user.highScores['space_invaders'] || 0;
                document.getElementById('profileRole').textContent = user.role;
                
                // Photo de profil
                document.getElementById('profilePicture').src = user.profilePictureUrl;
                
                // Skins
                const activeShipElement = document.getElementById('activeShip');
                if(activeShipElement) {
                     activeShipElement.textContent = user.skins.active.ship;
                }

                // Affichage du profil
                document.getElementById('profileView').style.display = 'block';
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'none';

                // Nettoyer les champs du formulaire de mise √† jour
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';
                document.getElementById('newProfilePicUrl').value = '';

            } else {
                // Affichage Connexion/Inscription
                showLogin();
                document.getElementById('profileView').style.display = 'none';
            }
        }
        
        // Fonction de d√©connexion globale
        window.logoutUser = function() {
            logout();
            renderAccountPage();
            updateTopBar();
        }

        // FONCTION DE VALIDATION CONNEXION (Appel√©e par le lien)
        window.validateLogin = function() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            // Validation manuelle
            if (!username || !password) {
                alert("Veuillez remplir tous les champs.");
                return; 
            }
            
            if (loginUser(username, password)) {
                renderAccountPage();
                updateTopBar();
            }
        }

        // FONCTION DE VALIDATION INSCRIPTION (Appel√©e par le lien)
        window.validateRegister = function() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;

            // Validation manuelle
            if (!username || !password) {
                alert("Veuillez remplir tous les champs.");
                return;
            }
            
            if (registerUser(username, password)) {
                renderAccountPage();
                updateTopBar();
            }
        }

        // Initialisation des listeners (uniquement pour la mise √† jour du profil)
        document.addEventListener('DOMContentLoaded', () => {
            renderAccountPage();
            
            // --- LISTENER DE MISE √Ä JOUR DE PROFIL (sur la soumission du formulaire) ---
            document.getElementById('profileUpdateForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const newPass = document.getElementById('newPassword').value;
                const confirmPass = document.getElementById('confirmNewPassword').value;
                const newPicUrl = document.getElementById('newProfilePicUrl').value;
                
                let passwordToUpdate = null;
                
                if (newPass) {
                    if (newPass !== confirmPass) {
                        alert("Erreur : Le nouveau mot de passe et sa confirmation ne correspondent pas.");
                        return;
                    }
                    if (newPass.length < 4) { 
                        alert("Le mot de passe doit contenir au moins 4 caract√®res.");
                        return;
                    }
                    passwordToUpdate = newPass;
                }

                if (updateProfile(passwordToUpdate, newPicUrl)) {
                    renderAccountPage(); 
                    updateTopBar(); 
                }
            });
            
            updateTopBar();
        });
    </script>
</body>
</html>
